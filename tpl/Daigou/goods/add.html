<layout name='layout' />

<form class="layui-form">
	<div class="layui-tab">
		<ul class="layui-tab-title">
			<li class="layui-this">通用信息</li>
			<li>商品相册</li>
			<li>商品模型</li>
			<li>贴心服务</li>
  		</ul>
		<div class="layui-tab-content">
			<!--基本信息-->
			<div class="layui-tab-item layui-show">
				<div class="layui-form-item">
					<label class="layui-form-label">名称</label>
					<div class="layui-input-block">
						<input type="text" name="name" lay-verify="required" placeholder="请输入商品名称" class="layui-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">描述</label>
					<div class="layui-input-block">
						<input type="text" name="intr" placeholder="一句话描述商品" class="layui-input">
					</div>
				</div>

				<div class="layui-form-item layui-form-text">
					<label class="layui-form-label">图片</label>
					<div class="layui-input-inline" style="width:400px">
						<input type="text" id="picname" name="picname" class="layui-input">
					</div>
					<div class="layui-inline">
						<button type="button" class="layui-btn"
						 id="uploud"
						 url="{:U('Upload/image')}"
						 size="5120"
						 exts="jpg|png|gif|jpeg"
						 accept="images"
						 tag="picname"
						 >上传图片</button>
						 <i class="layui-icon showImage" tag="picname">&#xe64a;</i>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">分类</label>
					<div class="layui-input-inline">
						<select name="cid" id="cid" lay-verify="required">
				    	<option value="">==请选择==</option>
				        <volist name="cate" id="vo">
				        <option value="{$vo['id']},{$vo['path']}"><?php
				            for($i=0; $i<$vo['count']*2; $i++){
				               echo '&nbsp;&nbsp;';            
				            }
				        ?>{$vo['name']}</option>
				        </volist>
				        </select>
					</div>
					<label class="layui-form-label">品牌</label>
					<div class="layui-input-inline">
						<select name="brandID" class="fsSelect fsDict" dict="brand" addNull="1">
	      				</select>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">状态</label>
					<div class="layui-input-inline">
						<input type="radio" name="show" value="1" title="显示" checked="checked">
						<input type="radio" name="show" value="0" title="隐藏">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">首页推荐</label>
					<div class="layui-input-inline">
						<input type="radio" name="comm" value="1" title="是">
						<input type="radio" name="comm" value="0" title="否" checked="checked">
					</div>
				</div>

				<div class="layui-form-item">
					
					<label class="layui-form-label">价格</label>
					<div class="layui-input-inline">
						<input type="text" name="price" lay-verify="required" autocomplete="off" class="layui-input" />
					</div>
			
					<label class="layui-form-label">库存</label>
					<div class="layui-input-inline">
						<input type="text" name="kucun" autocomplete="off" class="layui-input" />
					</div>
				
					<label class="layui-form-label">重量(kg)</label>
					<div class="layui-input-inline">
						<input type="text" name="weight" autocomplete="off" class="layui-input" />
					</div>			
				</div>

				<div class="layui-form-item">
					<!-- <label class="layui-form-label">运费(kg)</label>
					<div class="layui-input-inline">
						<input type="text" name="yunfei" id="yunfei" class="layui-input">
					</div> -->

					<label class="layui-form-label">包裹类型</label>
					<div class="layui-input-inline">
						<select name="baoguoID" class="fsSelect fsDict" dict="baoguo" lay-verify="required" addNull="1">
	      				</select>
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">初始销量</label>
					<div class="layui-input-inline">
						<input type="text" name="sellNumber" value="0" class="layui-input">
					</div>

					<label class="layui-form-label">排序</label>
					<div class="layui-input-inline">
						<input type="text" name="sort" id="sort" value="1" class="layui-input">
					</div>
				</div>

				<div class="layui-form-item">
					<label class="layui-form-label">是否包邮</label>
					<div class="layui-input-inline">
						<input type="checkbox" value="1" lay-text="是|否" lay-filter="baoyou" lay-skin="switch">
						<input type="hidden" name="isBaoyou" id="isBaoyou" value="0">
					</div>
				</div>				

				<div class="layui-form-item">
					<label class="layui-form-label">正文</label>
					<div class="layui-input-block">
						<textarea name="content" id="container" lay-verify="content">文章正文</textarea>
						<script type="text/javascript" src="{:C('UE_CONFIG.uedir')}/my.config.js"></script>
						<script type="text/javascript" src="{:C('UE_CONFIG.uedir')}/ueditor.all.min.js"></script>
						<script type="text/javascript" src="{:C('UE_CONFIG.uedir')}/lang/zh-cn/zh-cn.js"></script>
						<script type="text/javascript">
						var editor = UE.getEditor('container');
						</script>
					</div>
				</div>
			</div>

			<!--相册-->
			<div class="layui-tab-item">
				<div class="insert-img" id="insert-img">
					<a href="javascript:;" class="insert-btn"
					 id="muploud"
					 url="{:U('Upload/image')}"
					 size="5120"
					 exts="jpg|png|gif|jpeg"
					 accept="images"
					 tag="insert-img"
					 >+</a> 
				</div>				
			</div>

			<!--规格-->
			<div class="layui-tab-item">				
				<div class="layui-form-item">
					<label class="layui-form-label">商品模型</label>
					<div class="layui-input-inline">
						<select name="typeID" class="fsSelect fsDict" dict="goodsType" addNull="1" lay-filter="goodsModel">
	      				</select>
					</div>
				</div>
				
				<div class="layui-row">
					<div class="layui-col-md8" id="ajax_spec_data" style="padding-right:20px"></div>

					<div class="layui-col-md4" id="goods_attr_table"></div>
				</div>
			</div>

			<!--贴心服务-->
			<div class="layui-tab-item">				
				<volist name="server" id="vo">			
				<p style="padding: 10px 0"><input type="checkbox" name="server[]" lay-skin="primary" title="{$vo.name}" value="{$vo.id}" checked="checked"></p>
				</volist>
			</div>
		</div>
	</div>

	<hr>

	<div class="layui-form-item">
		<label class="layui-form-label"></label>
	    <button id="subBtn" class="layui-btn" lay-submit="" lay-filter="save" url="{:U('Goods/add')}">新增</button>

	    <button type="button" class="layui-btn layui-btn-primary" function="close">关闭</button>
	</div>
	<input type="hidden" id="goods_id" value="">
	<input type="hidden" name="agentID" value="{$user.id}">
</form>
<script>
/** 以下 商品规格相关 js*/
$(document).ready(function() {
	layui.use(['form','layer'],function(){
		var form = layui.form;
		var layer = layui.layer;

		form.on('switch(baoyou)', function(data){
			if(data.elem.checked){ //开关是否开启，true或者false
				$("#isBaoyou").val("1");
			}else{
				$("#isBaoyou").val("0");
			}
		});

		$(".showImage").click(function(){
			var o = $(this).attr("tag");
			if ($("#"+o).val()!=''){
				layer.open({
					area: ['50%', '50%'],
					content: '<img src="'+$("#"+o).val()+'" />'
				});
			};
		});

		form.on('select(goodsModel)', function(data){
			var goods_id = '{$list.id}';
	        var spec_type = data.value;
	        $.ajax({
	            type: 'GET',
	            data: {
	                goods_id: goods_id,
	                spec_type: spec_type
	            },
	            url: "{:U('Agent/Goods/ajaxGetSpecSelect')}",
	            success: function(data) {
	                $("#ajax_spec_data").html(data);
	                form.render();	
	                ajaxGetSpecInput(); // 触发完  马上触发 规格输入框
	            }
	        });
	        //商品类型切换时 ajax 调用  返回不同的属性输入框     
	        $.ajax({
	            type: 'GET',
	            data: {
	                goods_id: goods_id,
	                type_id: spec_type
	            },
	            url: "{:U('Agent/Goods/ajaxGetAttrInput')}",
	            success: function(data) {
	                $("#goods_attr_table").html(data);
	                form.render();	
	            }
	        });

	        $("#ajax_spec_data").on("click", "button", function() {
				if ($(this).hasClass("layui-btn-primary")){
					$(this).removeClass("layui-btn-primary");
				}else{
					$(this).addClass("layui-btn-primary");
				}
				ajaxGetSpecInput();
			})
		});
	})
});

function ajaxGetSpecInput(){
	var spec_arr = {};// 用户选择的规格数组 	  	  
	// 选中了哪些属性	  
	$("#specBox button").each(function(){
	    if(!$(this).hasClass('layui-btn-primary')){
			var spec_id = $(this).attr('data-spec_id');
			var item_id = $(this).attr('data-item_id');
			if(!spec_arr.hasOwnProperty(spec_id))
				spec_arr[spec_id] = [];
		    spec_arr[spec_id].push(item_id);
			//console.log(spec_arr);
		}		
	});
	ajaxGetSpecInput2(spec_arr); // 显示下面的输入框	
}

function ajaxGetSpecInput2(spec_arr){	
	layui.use('form', function(){
		var form = layui.form;	  
		var goods_id = $("input[name='goods_id']").val();
		$.ajax({
			type:'POST',
			data:{spec_arr:spec_arr,goods_id:goods_id},
			url:"/index.php/Agent/Goods/ajaxGetSpecInput",
			success:function(data){ 
			   $("#goods_spec_table2").html('').append(data);
			   hbdyg();  // 合并单元格		
			   form.render();	   
			}
		});
	});	    
}

// 合并单元格
function hbdyg() {
    var tab = document.getElementById("spec_input_tab"); //要合并的tableID
    var maxCol = 2, val, count, start;  //maxCol：合并单元格作用到多少列  
    if (tab != null) {
        for (var col = maxCol - 1; col >= 0; col--) {
            count = 1;
            val = "";
            for (var i = 0; i < tab.rows.length; i++) {
                if (val == tab.rows[i].cells[col].innerHTML) {
                    count++;
                } else {
                    if (count > 1) { //合并
                        start = i - count;
                        tab.rows[start].cells[col].rowSpan = count;
                        for (var j = start + 1; j < i; j++) {
                            tab.rows[j].cells[col].style.display = "none";
                        }
                        count = 1;
                    }
                    val = tab.rows[i].cells[col].innerHTML;
                }
            }
            if (count > 1) { //合并，最后几行相同的情况下
                start = i - count;
                tab.rows[start].cells[col].rowSpan = count;
                for (var j = start + 1; j < i; j++) {
                    tab.rows[j].cells[col].style.display = "none";
                }
            }
        }
    }
}
</script>
<script src="{:RES}/js/upload.js"></script>